(window.webpackJsonp=window.webpackJsonp||[]).push([[247],{571:function(s,t,a){"use strict";a.r(t);var e=a(4),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"乐观锁-悲观锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#乐观锁-悲观锁"}},[s._v("#")]),s._v(" 乐观锁&悲观锁")]),s._v(" "),t("p",[t("strong",[s._v("悲观锁")]),s._v("：锁机制实现，是一种独占锁，一个事务开启悲观锁后，数据库会锁着正在查询的记录或表，其它事务查询会处于阻塞状态，尤其堆与长事务，会造成数据库的性能开销；")]),s._v(" "),t("p",[t("strong",[s._v("乐观锁")]),s._v("：不借助锁机制，在提交数据时，才会对数据的冲突进行检测，典型实现"),t("code",[s._v("CAS")]),s._v("，更新失败的概率高，占用CPU，会出现ABA问题；")]),s._v(" "),t("h2",{attrs:{id:"mysql锁分类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql锁分类"}},[s._v("#")]),s._v(" Mysql锁分类")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("全局锁")]),s._v(" "),t("blockquote",[t("p",[s._v("整个数据库处于只读状态，所有数据增删改&表结构更改操作都被阻塞，主要用于全库逻辑备份；")])])]),s._v(" "),t("li",[t("p",[s._v("表级锁")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("表锁")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//表级别的共享锁，也就是读锁；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),s._v(" t_student "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//表级别的独占锁，也就是写锁；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),s._v(" t_stuent "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("write")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("blockquote",[t("p",[s._v("表锁粒度太大，影响并发性能；")])])]),s._v(" "),t("li",[t("p",[s._v("元数据锁")]),s._v(" "),t("blockquote",[t("p",[s._v("保证当前用户对表执行CRUD，防止其他线程对这个表结构更改；")])])]),s._v(" "),t("li",[t("p",[s._v("意向锁")]),s._v(" "),t("p",[s._v("作用：为了"),t("strong",[s._v("快速判断表里是否有记录被加锁")]),s._v("，如果没有「意向锁」，那么加「独占表锁」时，就需要遍历表里所有记录，查看是否有记录存在独占锁，这样效率会很慢；")]),s._v(" "),t("ol",[t("li",[s._v("在使用 InnoDB 引擎的表里对某些记录加上「共享锁」之前，需要先在表级别加上一个「意向共享锁」；")]),s._v(" "),t("li",[s._v("在使用 InnoDB 引擎的表里对某些纪录加上「独占锁」之前，需要先在表级别加上一个「意向独占锁」；")])]),s._v(" "),t("blockquote",[t("p",[s._v("意向共享锁和意向独占锁是表级锁，不会和行级锁发生冲突；")])])])])]),s._v(" "),t("li",[t("p",[s._v("行级锁")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//对读取的记录加共享锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("share")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//对读取的记录加独占锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//对操作的记录加独占锁(X型锁)")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//对操作的记录加独占锁(X型锁)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("delete")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("blockquote",[t("p",[t("img",{attrs:{src:"https://aurora-nr.oss-cn-beijing.aliyuncs.com/20240301173851.png",alt:""}})]),s._v(" "),t("p",[s._v("上面这两条语句必须在一个事务中，"),t("strong",[s._v("因为当事务提交了，锁就会被释放")]),s._v(";")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Record Lock，记录锁，也就是仅仅把一条记录锁上；")])]),s._v(" "),t("li",[t("p",[s._v("Gap Lock，间隙锁，锁定一个范围，但是不包含记录本身，防止数据插入，是"),t("strong",[s._v("可以共存")]),s._v("的，一个事务获取间隙锁不会阻止另一个事务获取同一个间隙范围的间隙锁；")])]),s._v(" "),t("li",[t("p",[s._v("Next-Key Lock：Record Lock + Gap Lock 的组合，锁定一个范围，并且锁定记录本身。")])]),s._v(" "),t("li",[t("p",[s._v("插入意向锁：一个事务插入一条记录时，需要判断插入位置是否被其他事务加了"),t("strong",[s._v("间隙锁")]),s._v("，如果有插入操作阻塞，生成一个插入意向锁；")]),s._v(" "),t("blockquote",[t("p",[s._v("它是一种特殊的间隙锁，只用于并发插入操作，"),t("strong",[s._v("与间隙锁冲突")]),s._v("，两个事务同一个时间内不能一个拥有间隙锁，一个拥有该间隙区间内的插入意向锁；")])])])])])]),s._v(" "),t("h2",{attrs:{id:"update语句每家索引导致锁全表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#update语句每家索引导致锁全表"}},[s._v("#")]),s._v(" update语句每家索引导致锁全表？")]),s._v(" "),t("p",[s._v("一般情况，事务 A 的 update 语句中 where 若是等值查询，并且 id 是唯一索引，只会对 id = 1 这条记录加锁，事务 B 其它记录的更新操作并不会阻塞；")]),s._v(" "),t("p",[s._v("但是，"),t("strong",[s._v("在 update 语句的 where 条件没有使用索引，就会全表扫描，于是就会对所有记录加上 next-key 锁（记录锁 + 间隙锁），相当于把整个表锁住")]),s._v("；")]),s._v(" "),t("h2",{attrs:{id:"数据库死锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库死锁"}},[s._v("#")]),s._v(" 数据库死锁")]),s._v(" "),t("p",[s._v("Innodb引擎为解决可重复读隔离级别下的幻读问题，引入了临键锁；")]),s._v(" "),t("p",[s._v("死锁案例：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.xiaolincoding.com//mysql/other/90c1e01d0345de639e3426cea0390e80-20230309222252447.png",alt:"img"}})]),s._v(" "),t("blockquote",[t("p",[s._v("记录的最后一个记录为1006；")])]),s._v(" "),t("p",[s._v("两个事务都执行了"),t("code",[s._v("select ... for update")]),s._v("加了临键锁，锁的范围是(1006,+INF)，临键锁优化为间隙锁，"),t("strong",[s._v("间隙锁与间隙锁之间不冲突")]),s._v("；")]),s._v(" "),t("p",[s._v("但insert语句，会在间隙锁上获取插入意向锁，"),t("strong",[s._v("插入意向锁与间隙锁是冲突的")]),s._v("，事务A的插入意向锁等待事务B的间隙锁释放；")]),s._v(" "),t("blockquote",[t("p",[s._v("如何避免？")]),s._v(" "),t("p",[s._v("设置事务等待锁的超时时间；")])]),s._v(" "),t("h2",{attrs:{id:"mysql如何加行级锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql如何加行级锁"}},[s._v("#")]),s._v(" Mysql如何加行级锁？")]),s._v(" "),t("blockquote",[t("p",[s._v("加锁的对象是索引，加锁的基本单位 临键锁；")])]),s._v(" "),t("h3",{attrs:{id:"唯一索引等值查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#唯一索引等值查询"}},[s._v("#")]),s._v(" 唯一索引等值查询")]),s._v(" "),t("ul",[t("li",[s._v("记录存在，索引树上定位到这条记录，临键锁 退化为 记录锁；")]),s._v(" "),t("li",[s._v("记录不存在，索引树上定位到第一条 > 该查询记录的记录后，临键锁 退化为 间隙锁；")])]),s._v(" "),t("h3",{attrs:{id:"非唯一索引等值查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#非唯一索引等值查询"}},[s._v("#")]),s._v(" 非唯一索引等值查询")]),s._v(" "),t("blockquote",[t("p",[s._v("非唯一索引等值查询时，存在两个索引，一个是主键索引，另一个是非唯一索引，加锁时，同时会对两个索引都加锁；")]),s._v(" "),t("p",[s._v("对于主键索引加锁，只有满足查询条件的记录才会对它们的主键加锁；")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("记录存在，由于不是唯一索引，可能存在索引值相同的记录，扫描到不符合条件的非唯一索引的记录就停止扫描，在扫描过程中，对"),t("strong",[s._v("扫描到的非唯一索引加 临键锁")]),s._v("，对"),t("strong",[s._v("第一个不符合条件")]),s._v("的非唯一索引记录，临键锁 退化为 间隙锁；")]),s._v(" "),t("p",[s._v("同时在符合查询条件的记录的索引上加记录锁；")])]),s._v(" "),t("li",[t("p",[s._v("记录不存在，扫描到第一个不符合条件的非唯一索引记录，临键锁 退化为 间隙锁；")]),s._v(" "),t("p",[s._v("不存在满足查询条件的记录，不会对主键索引加锁；")])])]),s._v(" "),t("h3",{attrs:{id:"唯一索引范围查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#唯一索引范围查询"}},[s._v("#")]),s._v(" 唯一索引范围查询")]),s._v(" "),t("blockquote",[t("p",[s._v("会对每一个扫描到的索引加 临键锁；")])]),s._v(" "),t("ul",[t("li",[s._v(">= 的范围查询，因存在等值查询，如果等值查询的记录存在表中，临键锁退化为记录锁；")]),s._v(" "),t("li",[s._v("< 或 <= 的范围查询\n"),t("ul",[t("li",[s._v("条件值不存在表中，扫描到终止范围查询的记录时，该记录的索引的临键锁 退化为 间隙锁；其它扫描到的记录，还是临键锁；")]),s._v(" "),t("li",[s._v("条件值存在表中，< 范围查询 （同上），<= 返回查询 没有锁退化；")])])])]),s._v(" "),t("h3",{attrs:{id:"非唯一索引范围查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#非唯一索引范围查询"}},[s._v("#")]),s._v(" 非唯一索引范围查询")]),s._v(" "),t("p",[s._v("无锁退化，全是临键锁；")])])}),[],!1,null,null,null);t.default=n.exports}}]);